#!/bin/bash
set -e  # エラーで即座に終了

# ============================================
# 設定
# ============================================
MINECRAFT_DIR="{{ minecraft_dir }}"
DATA_DIR="{{ minecraft_data_dir }}"
BACKUP_DIR="{{ backup_dir }}"
S3_BUCKET="{{ backup_s3_bucket }}"
CONTAINER_NAME="minecraft-server"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="minecraft_backup_${DATE}.tar.gz"

# ============================================
# ログ関数
# ============================================
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >&2
    exit 1
}

# ============================================
# RCON コマンド実行
# ============================================
rcon_command() {
    docker exec -i ${CONTAINER_NAME} rcon-cli --password "{{ rcon_password }}" "$1"
}

# ============================================
# メイン処理
# ============================================
main() {
    log "=========================================="
    log "Minecraft Backup Started"
    log "=========================================="

    # コンテナが起動しているか確認
    if ! docker ps --format '{{"{{"}}.Names{{"}}"}}' | grep -q "^${CONTAINER_NAME}$"; then
        log "Minecraft container is not running. Skipping save-all."
    else
        log "Notifying players..."
        rcon_command "say [Server] バックアップを開始します。少しラグが発生する可能性があります。" || true

        log "Disabling auto-save..."
        rcon_command "save-off" || true

        log "Forcing save..."
        rcon_command "save-all" || true
        sleep 5  # 保存完了を待つ

        log "Re-enabling auto-save..."
        rcon_command "save-on" || true
    fi

    # バックアップディレクトリ作成
    mkdir -p "${BACKUP_DIR}"

    # バックアップ作成
    log "Creating backup archive..."
    cd "${MINECRAFT_DIR}"
    tar -czf "${BACKUP_DIR}/${BACKUP_FILE}" \
        --exclude='*.tmp' \
        --exclude='*.lock' \
        -C "${DATA_DIR}" .

    log "Backup file created: ${BACKUP_FILE}"
    log "Size: $(du -h ${BACKUP_DIR}/${BACKUP_FILE} | cut -f1)"

    # S3 にアップロード
    log "Uploading to S3..."
    aws s3 cp "${BACKUP_DIR}/${BACKUP_FILE}" "s3://${S3_BUCKET}/backups/${BACKUP_FILE}" \
        --region {{ aws_region }}

    log "Upload completed: s3://${S3_BUCKET}/backups/${BACKUP_FILE}"

    # ローカルの古いバックアップを削除（7日以上前）
    log "Cleaning up old local backups..."
    find "${BACKUP_DIR}" -name "minecraft_backup_*.tar.gz" -mtime +7 -delete

    # 完了通知
    if docker ps --format '{{"{{"}}.Names{{"}}"}}' | grep -q "^${CONTAINER_NAME}$"; then
        rcon_command "say [Server] バックアップが完了しました。" || true
    fi

    log "=========================================="
    log "Minecraft Backup Completed"
    log "=========================================="
}

# 実行
main "$@"
